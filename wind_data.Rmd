---
title: "wind_speed"
author: "Jake Eisaguirre"
date: "2/17/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(raster)
library(REdaS)
library(sf)
library(lubridate)
library(terra)
```

# date function
```{r}
date <- as.Date(Sys.time())

year <- year(date)

day <- format(as.Date(Sys.time(), format = "%Y-%m-%d"), format = "%d")

day <- c("01")

month <- format(as.Date(Sys.time(), format = "%Y-%m-%d"), format = "%m") 

```


# download u and v component of wind
```{r}

url_ucomp <- paste0("https://www.ncei.noaa.gov/thredds/ncss/model-nam218/",year , month, "/", year, month, day,"/nam_218_", year, month, day,"_0000_084.grb2?var=u-component_of_wind_planetary_boundary&north=34.75&west=-121.4&east=-117.07&south=32.36&disableProjSubset=on&horizStride=1")

download.file(url_ucomp, here("wind_u"))

wind_u <- here("wind_u")

wind_u <- raster(wind_u)

wind_u <- as.data.frame(rasterToPoints(wind_u))



url_vcomp <- "https://www.ncei.noaa.gov/thredds/ncss/model-nam218/202202/20220214/nam_218_20220214_1800_084.grb2?var=v-component_of_wind_planetary_boundary&north=34.75&west=-121.4&east=-117.07&south=32.36&disableProjSubset=on&horizStride=1&time_start=2022-02-18T06%3A00%3A00Z&time_end=2022-02-18T06%3A00%3A00Z&timeStride=1&vertCoord="

download.file(url_vcomp, here("wind_v"))

wind_v <- here("wind_v")

wind_v <- raster(wind_v)

wind_v <- as.data.frame(rasterToPoints(wind_v))
```

# convert u and v
```{r}

wind_data <- left_join(wind_u, wind_v, by = c("x", "y"))

wind_ras <- wind_data %>%
  mutate(wind = (sqrt((wind_u^2) + (wind_v^2)))*1.94) %>%
  mutate(angle = rad2deg(atan2(wind_u, wind_v))) %>%
  mutate(angle = ifelse(angle < 190, abs(angle)+180)) %>%
  dplyr::select(-c(wind_u, wind_v))

wind_ras <- wind_ras %>% 
  dplyr::select(-c(angle))


wind_spatial <- wind_ras %>%
  st_as_sf(coords = c("x", "y"), crs = "+proj=utm +zone=11 +datum=WGS84  +units=m") %>%
  st_transform(geometry, "+proj=longlat +datum=WGS84",
                                 crs = 4326)

```

```{r}
cha <- read_sf(here("data","shape", "channel_islands.shp")) %>% 
  mutate(geometry = st_transform(geometry, 4326))

ca <- read_sf(here("data","shape","s_11au16", "s_11au16.shp")) %>% 
  mutate(geometry = st_transform(geometry, 4326)) %>% 
  filter(NAME == "California")


# merged_shapes_mask <- bind_rows(ca, cha)
# 
# rm(cha, ca)
# gc()

```
# pal
```{r}

cols <- c("grey60", "violet", "blue", "green", "orange", "red", "black")

pal <- palette(c("grey60", "violet", "blue", "green", "orange", "red", "black"))

plot(pal(10))

```

```{r}

ggplot() +
  geom_raster(data = wind_ras, aes(x=x, y=y, fill = wind), interpolate = T,) +
  geom_quiver(data = wind_data, aes(x=x, y=y, u=cos(wind_u),v=sin(wind_v)), vecsize = 0.8,
              rescale = F) +
  theme_classic() +
  scale_fill_viridis_c(option = "turbo")
  
  +
  geom_sf(data = cha, color = "black", fill = "grey60")
```

