---
title: "wind_speed"
author: "Jake Eisaguirre"
date: "2/17/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(raster)
library(REdaS)
library(sf)
library(lubridate)
library(terra)
library(jsonlite)
library(httr)
library(ggquiver)

```

# date function
```{r}
date <- as.Date(Sys.time())

year <- year(date)

day <- format(as.Date(Sys.time(), format = "%Y-%m-%d"), format = "%d")

day <- c("01")

month <- format(as.Date(Sys.time(), format = "%Y-%m-%d"), format = "%m") 

```


# download u and v component of wind
```{r}


url_ucomp <- ("http://api.planetos.com/v1/datasets/noaa_nam_awips_12/area?polygon=[[-121,34],[-117,34],[-117,32],[-121,32],[-121,34]]&apikey=e5102ee5d77e422eaa5dea4124ba2165&csv=true&count=50000&variables=u-component_of_wind_planetary_boundary")


wind_u <- download.file(url_ucomp, here("wind_u"))

wind_u <- here("wind_u")

wind_u <- read_csv(wind_u)



url_vcomp <- "http://api.planetos.com/v1/datasets/noaa_nam_awips_12/area?polygon=[[-121,34],[-117,34],[-117,32],[-121,32],[-121,34]]&apikey=e5102ee5d77e422eaa5dea4124ba2165&csv=true&count=50000&variables=v-component_of_wind_planetary_boundary"

download.file(url_vcomp, here("wind_v"))

wind_v <- here("wind_v")

wind_v <- read_csv(wind_v)
```

# convert u and v
```{r}

wind_data <- left_join(wind_u, wind_v, by = c("axis:latitude", "axis:longitude"))

wind_data <- wind_data %>% 
  as.data.frame() %>% 
  dplyr::select(!c("axis:time.y", "axis:reftime.y")) 

names(wind_data) <- substring(names(wind_data), 6)

wind_data <- wind_data %>% 
  rename(reftime = reftime.x) %>% 
  rename(date = time.x) %>% 
  rename(u = `u-component_of_wind_planetary_boundary`) %>% 
  rename(v = `v-component_of_wind_planetary_boundary`)

wind_ras <- wind_data %>%
  mutate(wind = (sqrt((u^2) + (v^2)))*1.94) %>%
  mutate(angle = rad2deg(atan2(u, v))) %>%
  mutate(angle = ifelse(angle < 190, abs(angle)+180)) %>%
  dplyr::select(-c(u, v)) %>% 
  group_by(date) %>% 
  dplyr::select(!c("reftime", "angle")) %>% 
  rename(x = longitude) %>% 
  rename(y = latitude)%>% 
  dplyr::select(x, everything())

# clean_wind_ras <- wind_ras %>% 
#   pivot_wider(names_from = date, values_from = wind) %>% 
#   unnest() %>% 
#   dplyr::select(x, everything())


```
# Shape Files
```{r}
islands <- read_sf(here('data', "shape",'island_shape', "channel_islands.shp")) %>% 
  mutate(geometry = st_transform(geometry, crs = 4326))

ca <- read_sf(here('data', "shape","s_11au16", "s_11au16.shp")) %>% 
  mutate(geometry = st_transform(geometry, crs = 4326)) %>% 
  filter(NAME == "California") %>% 
  dplyr::select(geometry)

merged_shapes <- bind_rows(ca, islands)
```


```{r}
wind_res <- c(0.005, 0.005) 

new_ras_wind <- raster(xmn = -121.4,
                      xmx = -117.06,
                      ymn = 32.36,
                      ymx = 34.75,
                      res = wind_res)


r <- brick(new_ras_wind)

wind_coords <- st_as_sf(wind_ras, coords = c("x","y"))
wind_coords <- as(wind_coords, "Spatial") 

for(i in unique(wind_ras$date)) {
  
  rs <- addLayer(r, rasterize(wind_coords[wind_coords$date == i,], r, field = wind_coords$wind))
}



wind_res <- c(0.005, 0.005) 

new_ras_wind <- raster(xmn = -121.4,
                      xmx = -117.06,
                      ymn = 32.36,
                      ymx = 34.75,
                      res = wind_res)

re_samp_wind <- resample(rs, new_ras_wind, method = "bilinear")

cropped_wind <- mask(re_samp_wind, merged_shapes, inverse = T)

final_ras_wind <- projectRaster(cropped_wind, crs = 4326)
```


```{r}
cha <- read_sf(here("data","shape", "channel_islands.shp")) %>% 
  mutate(geometry = st_transform(geometry, 4326))

ca <- read_sf(here("data","shape","s_11au16", "s_11au16.shp")) %>% 
  mutate(geometry = st_transform(geometry, 4326)) %>% 
  filter(NAME == "California")


merged_shapes_mask <- bind_rows(ca, cha)
# 
# rm(cha, ca)
# gc()

```

# pal
```{r}

cols <- c("grey60", "violet", "blue", "green", "orange", "red", "black")

pal <- palette(c("grey60", "violet", "blue", "green", "orange", "red", "black"))

plot(pal(10))

```

```{r}

wind_ras <- wind_ras %>% 
  filter(date == "2022-04-12 12:00:00")

wind_data <- wind_data %>% 
  filter(date == "2022-04-12 12:00:00")

wind_ras_t <- wind_ras %>% 
    filter(longitude %in% sort(unique(longitude))[c(T, F, F, F, F, F, F, F, 
                                    F, F, F, F, F, F, F, F, F)], 
           latitude %in% sort(unique(latitude))[c(T, F, F, F, F, F, F, F, 
                                    F, F, F, F, F, F, F, F, F)])

ggplot(data = wind_ras) +
  geom_raster(aes(y=latitude, x=longitude, fill = wind), interpolate = T,) +
  geom_spoke(data = wind_ras_t, aes(y=latitude, x=longitude, angle = angle, 
                                           radius = scales::rescale(wind, c(.02, .15))), 
               arrow=arrow(length = unit(0.2,"cm"))) +
  theme_classic() +
  scale_fill_viridis_c(option = "turbo")
  
  +
  geom_sf(data = cha, color = "black", fill = "grey60")
```

