---
title: "wind_speed"
author: "Jake Eisaguirre"
date: "2/17/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(raster)
library(REdaS)
library(sf)
library(lubridate)
library(terra)
library(jsonlite)
library(httr)
library(ggquiver)
library(gstat)
library(automap)

```


# download u and v component of wind
```{r}


url_ucomp <- ("http://api.planetos.com/v1/datasets/noaa_nam_awips_12/area?polygon=[[-121.40,34.75],[-117.06,34.75],[-117.06,32.36],[-121.40,32.36],[-121.40,34.75]]&apikey=e5102ee5d77e422eaa5dea4124ba2165&csv=true&count=50000&variables=u-component_of_wind_planetary_boundary")


wind_u <- download.file(url_ucomp, here("wind_u.csv"))

wind_u <- here("wind_u.csv")

wind_u <- read_csv(wind_u)



url_vcomp <- "http://api.planetos.com/v1/datasets/noaa_nam_awips_12/area?polygon=[[-121.40,34.75],[-117.06,34.75],[-117.06,32.36],[-121.40,32.36],[-121.40,34.75]]&apikey=e5102ee5d77e422eaa5dea4124ba2165&csv=true&count=50000&variables=v-component_of_wind_planetary_boundary"

download.file(url_vcomp, here("wind_v.csv"))

wind_v <- here("wind_v.csv")

wind_v <- read_csv(wind_v)
```

# convert u and v
```{r}

wind_data <- left_join(wind_u, wind_v, by = c("axis:latitude", "axis:longitude"))

wind_data <- wind_data %>% 
  as.data.frame() %>% 
  dplyr::select(!c("axis:time.y", "axis:reftime.y")) 

names(wind_data) <- substring(names(wind_data), 6)

wind_data <- wind_data %>% 
  rename(reftime = reftime.x) %>% 
  rename(date = time.x) %>% 
  rename(u = `u-component_of_wind_planetary_boundary`) %>% 
  rename(v = `v-component_of_wind_planetary_boundary`)

wind_ras <- wind_data %>%
  mutate(wind = (sqrt((u^2) + (v^2)))*1.94) %>%
  mutate(angle = rad2deg(atan2(u, v))) %>%
  mutate(angle = ifelse(angle < 190, abs(angle)+180),
         date = as_datetime(date),
         date = as.factor(date)) %>%
  dplyr::select(-c(u, v)) %>% 
  group_by(date) %>% 
  dplyr::select(!c("reftime")) %>% 
  rename(x = longitude) %>% 
  rename(y = latitude)%>% 
  dplyr::select(x, everything()) %>% 
  relocate(wind, .before = date)


test <- wind_ras %>% 
  filter(date == "2022-04-26 12:00:00")


a <- rasterFromXYZ(test)

plot(a)
```


# Shape Files
```{r}
islands <- read_sf(here('data', "shape",'island_shape', "channel_islands.shp")) %>% 
  mutate(geometry = st_transform(geometry, crs = 4326))

ca <- read_sf(here('data', "shape","s_11au16", "s_11au16.shp")) %>% 
  mutate(geometry = st_transform(geometry, crs = 4326)) %>% 
  filter(NAME == "California") %>% 
  dplyr::select(geometry)

merged_shapes <- bind_rows(ca, islands)
```


```{r}


for(i in unique(wind_ras$date)) {
  
  ras <- rasterFromXYZ(wind_ras[wind_ras$date == unique(wind_ras$date)[i],])
}


wind_res <- c(0.005, 0.005) 

new_ras_wind <- raster(xmn = -121.4,
                      xmx = -117.06,
                      ymn = 32.36,
                      ymx = 34.75,
                      res = wind_res)

re_samp_wind <- resample(a, new_ras_wind, method = "bilinear")

cropped_wind <- mask(re_samp_wind, merged_shapes, inverse = T)

final_ras_wind <- projectRaster(cropped_wind, crs = 4326)

plot(final_ras_wind[[1]])


```


# pal
```{r}

cols <- c("grey60", "violet", "blue", "green", "orange", "red", "black")

pal <- palette(c("grey60", "violet", "blue", "green", "orange", "red", "black"))

plot(pal(10))

```

```{r}

wind_ras <- wind_ras %>% 
  filter(date == "2022-04-26 12:00:00")

wind_data <- wind_data %>% 
  filter(date == "2022-04-12 12:00:00")

wind_ras_t <- wind_ras %>% 
    filter(longitude %in% sort(unique(longitude))[c(T, F, F, F, F, F, F, F, 
                                    F, F, F, F, F, F, F, F, F)], 
           latitude %in% sort(unique(latitude))[c(T, F, F, F, F, F, F, F, 
                                    F, F, F, F, F, F, F, F, F)])

ggplot() +
  geom_raster(a, interpolate = T) 

+
  geom_spoke(data = wind_ras_t, aes(y=latitude, x=longitude, angle = angle, 
                                           radius = scales::rescale(wind, c(.02, .15))), 
               arrow=arrow(length = unit(0.2,"cm"))) +
  theme_classic() +
  scale_fill_viridis_c(option = "turbo")
  
  +
  geom_sf(data = cha, color = "black", fill = "grey60")
```

