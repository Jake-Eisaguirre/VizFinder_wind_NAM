---
title: "wind_speed"
author: "Jake Eisaguirre"
date: "2/17/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
library(tidyverse)
library(raster)
library(sf)
library(lubridate)
library(magick)



```

# Shape Files
```{r}
islands <- read_sf(here('data', "shape",'island_shape', "channel_islands.shp")) %>% 
  mutate(geometry = st_transform(geometry, crs = 4326))

ca <- read_sf(here('data', "shape","s_11au16", "s_11au16.shp")) %>% 
  mutate(geometry = st_transform(geometry, crs = 4326)) %>% 
  filter(NAME == "California") %>% 
  dplyr::select(geometry)

merged_shapes <- bind_rows(ca, islands)
```

# download NAM u and v component of wind

# run times: 02:00PST, 08:00PST, 14:00PST, 20:00PST
```{r}

date <- as_date(Sys.Date(), tz="UTC") %>% 
  str_replace("-","") %>% 
  str_replace("-","")

s <- Sys.time()

mod_time  <- as.character((.POSIXct(s, "UTC") - (3 * 60 * 60))) %>% 
  substring(12)

mod_time <-  str_sub(mod_time, 1, nchar(mod_time) -6)

mod_time <- "18"

mod.list <- c("00", "03", "06", "09", "12", "15", "18", "21", "24", "27", 
              "30", "33", "36", "39", "42", "45", "48", "51", "54", "57", "60", 
              "63", "66", "69", "72", "75", "78", "81", "84")

gribstring <- "wind_u_%s.grb"
wind.u <- vector("list", length(mod.list))



#U Vector  
unlink(here("grib_u/*"))
for(i in seq_along(mod.list)) {
  url_ucomp <- paste0("https://nomads.ncep.noaa.gov/cgi-bin/filter_nam.pl?file=nam.t", mod_time, "z.awphys" , mod.list[[i]] , ".tm00.grib2&lev_10_m_above_ground=on&var_UGRD=on&subregion=&leftlon=238.596&rightlon=242.936&toplat=35.00&bottomlat=32.36&dir=%2Fnam.", date)
  
  gribfile <- sprintf(gribstring, mod.list[i])
  
  download.file(url_ucomp, here("grib_u", gribfile))
  
}

wind_u_brick <- stack(here("grib_u", list.files(path = here("grib_u"), pattern = "*.grb"))) %>% 
  projectRaster(crs = 4326)


wind_u_csv <- rasterToPoints(wind_u_brick) %>% 
  as.data.frame() %>% 
  pivot_longer(!c(x,y), names_to = "date", values_to = "u")





# V vector - 
unlink(here("grib_v/*"))
for(i in seq_along(mod.list)) {
  
  url_ucomp <- paste0("https://nomads.ncep.noaa.gov/cgi-bin/filter_nam.pl?file=nam.t", mod_time, "z.awphys" , mod.list[[i]] , ".tm00.grib2&lev_10_m_above_ground=on&var_VGRD=on&subregion=&leftlon=238.596&rightlon=242.936&toplat=35.00&bottomlat=32.36&dir=%2Fnam.", date)
  
  gribfile <- sprintf(gribstring, mod.list[i])
  
  download.file(url_ucomp, here("grib_v", gribfile))
  
}


wind_v_brick <- stack(here("grib_v", list.files(path = here("grib_v"), pattern = "*.grb"))) %>% 
  projectRaster(crs = 4326) 


wind_v_csv <- rasterToPoints(wind_v_brick) %>% 
  as.data.frame() %>% 
  pivot_longer(!c(x,y), names_to = "date", values_to = "v")



```


# average for wind vectors
```{r}

agg_u_vecs <- mask(wind_u_brick, merged_shapes, inverse = T) %>% 
  rasterToPoints() %>% 
  as.data.frame() %>% 
  pivot_longer(!c(x,y), names_to = "date", values_to = "u") %>% 
  group_by(x,y, date) %>% 
  summarise(u = mean(u))


agg_v_vecs <- mask(wind_v_brick, merged_shapes, inverse = T) %>% 
  rasterToPoints() %>% 
  as.data.frame() %>% 
  pivot_longer(!c(x,y), names_to = "date", values_to = "v") %>% 
  group_by(x,y, date) %>% 
  summarise(v = mean(v))
 


vec_data <- left_join(agg_u_vecs, agg_v_vecs, by = c("x", "y", "date"))

vec <- vec_data %>%
  mutate(angle = (270 - (atan2(u, v) * (180/pi))%%360)) %>%  
  dplyr::select(x, everything()) %>% 
  dplyr::select(!c(u,v))

vec$date <- str_replace(vec$date, "wind_u_", "")

rm(wind_v_brick, wind_u_brick, vec_data, agg_v_vecs, agg_u_vecs)
gc()
```


# convert u and v
```{r}

wind_data <- left_join(wind_u_csv, wind_v_csv, by = c("x", "y", "date")) 
  
  
wind_data$date <- str_replace(wind_data$date, "wind_u_", "")
  

wind_ras <- wind_data %>%
  group_by(x,y,date) %>% 
  mutate(wind = ((sqrt((u^2) + (v^2)))),
         date = as.factor(date)) %>%
  dplyr::select(-c(u, v)) %>% 
  dplyr::select(x, everything()) %>% 
  relocate(wind, .before = date) %>% 
  mutate(wind = wind*1.94)



rm(wind_data, wind_u_csv, wind_v_csv)
gc()
```

# date conversion
```{r}

utc_time <- as_datetime(s, "UTC")

pst_dates <-list()

mod_runs <- mod.list %>% 
  as.numeric()


for(i in 1:length(mod_runs)){
  
pst_dates[[i]] <- (utc_time + ((mod_runs[[i]]-2)*60*60)) %>% 
  as_datetime(tz = "America/Los_Angeles")

}

pst <- pst_dates %>% 
  as.numeric() %>% 
  as.POSIXct(origin = "1970-01-01")


rm(pst_dates)
gc()

```


# loop
```{r message=F, warning=F}

ras <- brick(xmn = -122.0514,
             xmx = -116.6754,
             ymn = 31.7689,
             ymx = 35.6209,
             nrows = 36,
             ncol = 42)

for(i in 1:length(levels(wind_ras$date))) {

  ras[[i]] <- wind_ras %>% 
    filter(date == levels(date)[i]) %>% 
    rasterFromXYZ() %>% 
    dropLayer(2)
}

names(ras) <-  pst


```



# resample 
```{r}

wind_res <- c(0.005, 0.005)

new_ras_wind <- raster(xmn = -121.45,
                      xmx = -117.05,
                      ymn = 32.35,
                      ymx = 34.75,
                      res = wind_res)

re_samp_wind <- resample(ras, new_ras_wind, method = "bilinear")

cropped_wind <- mask(re_samp_wind, merged_shapes, inverse = T)

final_ras_wind <- projectRaster(cropped_wind, crs = 4326)

rm(new_ras_wind, re_samp_wind, ras)
gc()

```

# points
```{r}

wind_ras_data <- as.data.frame(rasterToPoints(final_ras_wind)) %>% 
  pivot_longer(!c(x,y), names_to = "date", values_to = "wind") 


```

# pal
```{r}

wind_pal <- colorRampPalette(c( "#7635b8", "#3a57ba","#5bc752", "#cc8247", "#ab3c4d", "#bf4182", "#bf548b" ))

wind_limits <- c(0,50)

wind_values <- c(0, 10, 20, 30, 40, 50)

```


```{r}
wind.list = lapply(sort(unique(wind_ras_data$date)), function(i) {
  ggplot(data = wind_ras_data[wind_ras_data$date==i,], aes(y=y, x=x)) +
  geom_raster(aes(fill = wind), interpolate = T) +
  facet_wrap(levels(~date)) +
  scale_fill_gradientn(colours = wind_pal(100), limits = wind_limits, breaks = wind_values) +
  theme_classic() +
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),legend.position="none",
          axis.title.y=element_blank(),
          panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        plot.margin=unit(c(0,0,0,0), "null"),
        strip.background = element_blank(),
        strip.text.x = element_blank()) +
  coord_sf(xlim = c(-121.45, -117.06), ylim = c(32.36, 34.75), expand = F, datum = 3857)
})


```


# loop to create each plot for wind vector 
```{r}
new.wind.list <- list()
for(i in seq_along(wind.list)){
  
  new.wind.list[[i]] <- wind.list[[i]] +
    geom_text(data = vec[vec$date==unique(vec$date)[i],], aes(angle=-angle+90), label="â†’", check_overlap = T, size = 2)
}

rm(wind.list)
gc()
```


```{r}


wind_ras_data$date <- sub("X", "", wind_ras_data$date)

wind_ras_data$date <- str_sub(wind_ras_data$date, 1, nchar(wind_ras_data$date) -6)


w_dpi <- c(215)

unlink("pngs/old/*")

for(i in 1:length(new.wind.list)){
  
  ggsave(paste0(here('pngs', 'old'), "/", wind_ras_data$date[i], '.png'), dpi = w_dpi, 
         bg = "transparent", plot = new.wind.list[[i]])
}
```

```{r}
unlink("pngs/site_ready/*")

for(i in 1:length(new.wind.list)){
  hs <- image_read(paste0(here('pngs', 'old'), "/", wind_ras_data$date[i], '.png'))
  hs <- image_trim(hs)
  hs <- image_transparent(hs, "white")
  image_write(hs, paste0(here('pngs', 'site_ready'), "/", wind_ras_data$date[i], '.png'))
}

```

